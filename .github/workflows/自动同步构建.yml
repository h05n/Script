name: 自动同步构建

on:
  # 监听设置或加工器的变动，保存即刻触发
  push:
    paths:
      - '设置.json'
      - '自动加工器.js'
  # 允许在 GitHub Actions 页面手动点击运行
  workflow_dispatch:
  # 按照要求：每 1 小时自动检查一次
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write

# 自动清理重复任务，节省 GitHub 资源
concurrency:
  group: sync-v6
  cancel-in-progress: true

jobs:
  automation_job:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出仓库文件
        uses: actions/checkout@v4

      - name: 2. 安装 Node 运行环境
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 3. 同步并校验原作者代码
        shell: bash
        run: |
          mkdir -p temp_box
          echo "开始尝试从源头同步代码..."
          
          # 多节点下载，防止网络波动
          if ! curl -fsSL -L --retry 3 "https://unpkg.com/@forward-widget/danmu-universe" -o "temp_box/origin.js"; then
            curl -fsSL -L --retry 3 "https://cdn.jsdelivr.net/npm/@forward-widget/danmu-universe" -o "temp_box/origin.js"
          fi
          
          # 安全校验：文件必须包含核心标识，且大小不得少于 1000 字节（防止下载到错误网页）
          if ! grep -q "WidgetMetadata" temp_box/origin.js || [ $(wc -c < temp_box/origin.js) -lt 1000 ]; then
            echo "同步失败：源码无效或已损坏，放弃本次加工。"
            exit 1
          fi

      - name: 4. 执行自动加工
        run: |
          # 运行加工器，将同步来的 origin.js 加工成“最终成品.js”
          node 自动加工器.js temp_box/origin.js 最终成品.js 设置.json

      - name: 5. 检查差异并推送同步
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add 最终成品.js
          
          # 仅在成品内容发生字符变动时才提交，防止无意义的日志堆积
          if ! git diff --staged --quiet; then
            git commit -m "chore: 成品已根据最新同步与设置重新生成"
            git push
          else
            echo "自查完毕：内容无变化，跳过提交。"
          fi
          
          # 清理临时工作盒
          rm -rf temp_box
